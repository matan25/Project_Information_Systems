{# =========================================================
   Template: search_flights.html
   Purpose: Public flight search for customers and guests.
            Shows future ACTIVE flights with AVAILABLE seats only.
            Supports filtering by origin/destination and by departure/arrival date.
            Displays remaining seats and starting (minimum) seat price per flight,
            with a link to the seat selection flow.
   ========================================================= #}
{# templates/search_flights.html #}
{% extends "base.html" %}
{% block title %}Search Flights • FlyTAU{% endblock %}

{% block extra_head %}
<style>
  .seats-low {
    color: #ff4c4c;
    font-weight: 600;
  }

  .seats-ok {
    color: #00c853;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-main">
  <div class="page-card">

    <div class="card-form-header">
      <div>
        <h1 class="page-title">Search Flights</h1>
        <p class="subtitle">
          Find your next destination with FLYTAU.<br>
          Both registered customers and guests can search and book flights.
        </p>

        {# ---- Back button (dynamic) - aligned with your session logic ---- #}
        <div style="margin-top: 10px;">
          {% if session.get('role') == 'customer' and session.get('customer_email') %}
            <a href="{{ url_for('main.customer_home') }}" class="btn-small">
              Back to my area
            </a>
          {% elif session.get('role') == 'manager' and session.get('manager_id') %}
            <a href="{{ url_for('main.manager_home') }}" class="btn-small">
              Back to dashboard
            </a>
          {% else %}
            <a href="{{ url_for('auth.login', role='customer') }}" class="btn-small">
              Back to login
            </a>
          {% endif %}
        </div>
      </div>

      <div class="card-form-logo">
        <img src="{{ url_for('static', filename='img/flytau-logo.png') }}"
             alt="FLYTAU logo">
      </div>
    </div>

    <form method="get"
          action="{{ url_for('main.search_flights') }}"
          class="flight-search-form">

      <h2 class="form-section-title">Flight filters</h2>
      <p class="hint-text">
        All future active flights with available seats are shown below.
        Use the filters to narrow down by origin, destination and date
        (by <strong>departure</strong> or <strong>arrival</strong> date).
      </p>

      <div class="form-grid">
        <!-- Origin -->
        <div class="form-row">
          <label for="origin">From</label>
          <select id="origin" name="origin">
            <option value=""
                    {% if not search_params.origin %}selected{% endif %}>
              All origins
            </option>
            {% for airport in airports %}
              <option value="{{ airport.Airport_code }}"
                      {% if search_params.origin == airport.Airport_code %}selected{% endif %}>
                {{ airport.City }} ({{ airport.Airport_code }})
              </option>
            {% endfor %}
          </select>
          <div class="field-hint">
            Departure airport (origin). Leave empty for all origins.
          </div>
        </div>

        <!-- Destination -->
        <div class="form-row">
          <label for="dest">To</label>
          <select id="dest" name="dest">
            <option value=""
                    {% if not search_params.dest %}selected{% endif %}>
              All destinations
            </option>
            {% for airport in airports %}
              <option value="{{ airport.Airport_code }}"
                      {% if search_params.dest == airport.Airport_code %}selected{% endif %}>
                {{ airport.City }} ({{ airport.Airport_code }})
              </option>
            {% endfor %}
          </select>
          <div class="field-hint">
            Arrival airport (destination). Leave empty for all destinations.
          </div>
        </div>

        <!-- Date type (departure / arrival) -->
        <div class="form-row">
          <label for="date_type">Date filter type</label>
          <select id="date_type" name="date_type">
            <option value="dep"
                    {% if not search_params.date_type or search_params.date_type != 'arr' %}selected{% endif %}>
              Departure date
            </option>
            <option value="arr"
                    {% if search_params.date_type == 'arr' %}selected{% endif %}>
              Arrival date
            </option>
          </select>
          <div class="field-hint">
            Choose whether the date filter refers to departure or arrival date.
          </div>
        </div>

        <!-- Date -->
        <div class="form-row datetime-wrapper">
          <label for="date">Date</label>
          <input type="date"
                 id="date"
                 name="date"
                 value="{{ search_params.date }}"
                 min="{{ today_str }}">
          <div class="field-hint">
            Optional. If empty, flights from all future dates are shown.
          </div>
        </div>

        <!-- Search / filter buttons -->
        <div class="form-row" style="align-self: flex-end; display:flex; gap:8px;">
          <button type="submit" class="btn-primary">
            Apply filters
          </button>
          <button type="button"
                  class="btn-secondary"
                  onclick="window.location='{{ url_for('main.search_flights') }}'">
            Clear filters
          </button>
        </div>
      </div>
    </form>

    <hr style="margin: 24px 0; opacity: 0.12;">

    {% if flights %}
      <h2 class="section-title" style="margin-top: 0;">
        {% if search_params.origin or search_params.dest or search_params.date %}
          Filtered results
        {% else %}
          All available flights
        {% endif %}
      </h2>
      <p class="field-hint" style="margin-bottom: 10px;">
        Showing active future flights with available seats only.
        Seat count is <span class="seats-low">red</span> when 3 or fewer seats remain,
        and <span class="seats-ok">green</span> otherwise.
      </p>

      <div class="table-shell"
           style="max-height: 420px; overflow-y: auto; overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>Flight</th>
              <th>Departure</th>
              <th>Arrival</th>
              <th>Aircraft</th>
              <th>Available seats</th>
              <th>Starting price</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for f in flights %}
              <tr>
                <td>
                  <strong>{{ f.Flight_id }}</strong><br>
                  <span style="font-size: 11px; color: #c0c7ff;">
                    {{ f.Origin_Airport_code }} → {{ f.Destination_Airport_code }}
                    · {{ f.Duration_Minutes }} min
                  </span>
                </td>
                <td>
                  <span style="font-size: 15px; font-weight: 600;">
                    {{ f.Dep_DateTime.strftime("%d/%m/%Y %H:%M") }}
                  </span><br>
                  <small>{{ f.Origin_Airport_code }}</small>
                </td>
                <td>
                  <span style="font-size: 15px; font-weight: 600;">
                    {{ f.Arr_DateTime.strftime("%d/%m/%Y %H:%M") }}
                  </span><br>
                  <small>{{ f.Destination_Airport_code }}</small>
                </td>
                <td>{{ f.AircraftModel }}</td>
                <td>
                  {% set seats = f.Available_Seats or 0 %}
                  {% if seats > 0 %}
                    <span class="{% if seats <= 3 %}seats-low{% else %}seats-ok{% endif %}">
                      {{ seats }}
                    </span>
                  {% else %}
                    <span class="readonly-value status-sold">Sold out</span>
                  {% endif %}
                </td>
                <td>
                  ${{ "%.2f"|format(f.Min_Price) }}
                </td>
                <td>
                  <a href="{{ url_for('main.select_seats',
                                      flight_id=f.Flight_id) }}"
                     class="btn-small btn-primary">
                    Select seats
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty-state">
        <h3 style="margin-top: 0;">No flights found</h3>
        <p class="field-hint">
          There are no active future flights with available seats that match
          the current filters. Try different dates or airports.
        </p>
      </div>
    {% endif %}

    <div style="margin-top: 24px; font-size: 13px; color: #a2acd9;">
      <p>
        Registered customer?
        <a href="{{ url_for('auth.login', role='customer') }}">
          Sign in to your customer area
        </a>.<br>
        Guest passenger? You can later view your booking using the
        “Guest booking lookup” screen (available from the main menu).
      </p>
    </div>

  </div>
</div>
{% endblock %}
