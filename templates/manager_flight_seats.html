{# =========================================================
   Template: manager_flight_seats.html
   Purpose: Manage seat prices (PER CLASS) and seat statuses for a flight.
            - Price updates apply to ALL non-sold seats in the class (Available + Blocked).
            - Status changes are per seat for non-sold seats.
            - Read-only mode for departed/cancelled/completed.
   ========================================================= #}

{% extends "base.html" %}

{% block title %}
  Flight {{ flight.Flight_id }} — Seat pricing • FlyTAU Manager
{% endblock %}

{% block extra_head %}
<style>
  .seat-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem 1.25rem;
    margin-bottom: 0.9rem;
    align-items: flex-end;
  }
  .seat-toolbar-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 160px;
  }
  .seat-toolbar-group label {
    font-size: 0.85rem;
    font-weight: 500;
  }
  .seat-toolbar .toolbar-actions {
    margin-left: auto;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  .seatmap-footer {
    margin-top: 2rem;
    text-align: center;
  }
  .seatmap-footer img {
    max-width: 100%;
    border-radius: 16px;
    box-shadow: 0 14px 40px rgba(0, 0, 0, 0.55);
    border: 1px solid rgba(255, 255, 255, 0.08);
    display: block;
    margin: 0 auto;
  }
  .seatmap-footer-caption {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    opacity: 0.85;
  }

  .class-pricing-box {
    margin: 1rem 0 1.2rem 0;
    padding-top: 0.9rem;
    border-top: 1px solid rgba(148,163,255,0.35);
  }
  .hint {
    margin: 0.35rem 0 0.6rem 0;
    opacity: 0.85;
    font-size: 0.92rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    /* --------- Filtering ---------- */
    const classFilter   = document.getElementById('filter-seat-class');
    const statusFilter  = document.getElementById('filter-seat-status');
    const textFilter    = document.getElementById('filter-seat-text');
    const clearBtn      = document.getElementById('filter-clear');
    const seatRows      = document.querySelectorAll('tr.seat-row');

    function applyFilters() {
      const fClass  = classFilter ? classFilter.value : 'ALL';
      const fStatus = statusFilter ? statusFilter.value : 'ALL';
      const fText   = (textFilter && textFilter.value || '').trim().toLowerCase();

      seatRows.forEach(function (row) {
        const seatClass  = row.getAttribute('data-seat-class');
        const seatStatus = row.getAttribute('data-seat-status');
        const label      = (row.getAttribute('data-seat-label') || '').toLowerCase();

        let visible = true;

        if (fClass !== 'ALL' && seatClass !== fClass) visible = false;
        if (fStatus !== 'ALL' && seatStatus !== fStatus) visible = false;
        if (fText && !label.includes(fText)) visible = false;

        row.style.display = visible ? '' : 'none';
      });
    }

    if (classFilter)  classFilter.addEventListener('change', applyFilters);
    if (statusFilter) statusFilter.addEventListener('change', applyFilters);
    if (textFilter)   textFilter.addEventListener('input', applyFilters);

    if (clearBtn) {
      clearBtn.addEventListener('click', function (e) {
        e.preventDefault();
        if (classFilter)  classFilter.value  = 'ALL';
        if (statusFilter) statusFilter.value = 'ALL';
        if (textFilter)   textFilter.value   = '';
        applyFilters();
      });
    }

    /* --------- Apply class price (UI only; no DB save) ---------- */
    function applyClassPriceUI(seatClass, inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;

      const val = parseFloat(input.value);
      if (isNaN(val) || val <= 0) return;   // <-- enforce strictly positive (UI)

      seatRows.forEach(function(row) {
        const rowClass  = row.getAttribute('data-seat-class');
        const rowStatus = row.getAttribute('data-seat-status');

        // Update only NOT Sold (Available + Blocked)
        if (rowClass !== seatClass) return;
        if (rowStatus === 'Sold') return;

        const priceSpan = row.querySelector('.js-seat-price');
        if (priceSpan) {
          priceSpan.textContent = val.toFixed(2) + ' $';
        }
      });
    }

    const applyBusinessBtn = document.getElementById('apply-business-btn');
    if (applyBusinessBtn) {
      applyBusinessBtn.addEventListener('click', function(e){
        e.preventDefault();
        applyClassPriceUI('Business', 'class_price_Business');
      });
    }

    const applyEconomyBtn = document.getElementById('apply-economy-btn');
    if (applyEconomyBtn) {
      applyEconomyBtn.addEventListener('click', function(e){
        e.preventDefault();
        applyClassPriceUI('Economy', 'class_price_Economy');
      });
    }
  });
</script>
{% endblock %}

{% block content %}
<div class="page-card manager-card">

  <div class="card-form-header">
    <div>
      <h1 class="page-title">
        Flight {{ flight.Flight_id }} — Seat pricing
      </h1>
      <p class="subtitle">
        {{ flight.Origin_Airport_code }} → {{ flight.Destination_Airport_code }}
        · {{ flight.Dep_str }} → {{ flight.Arr_str }}
        · Aircraft: {{ flight.AircraftModel }}
      </p>
      {% if is_readonly %}
        <p class="hero-badge badge-readonly">
          Read-only: flight already departed or is Cancelled/Completed
        </p>
      {% endif %}
    </div>
    <div class="card-form-logo">
      <img src="{{ url_for('static', filename='img/flytau-logo.png') }}"
           alt="FLYTAU logo"
           class="brand-logo-img">
    </div>
  </div>

  <section class="form-card wide">
    {% if is_readonly %}
      <p class="field-hint">
        This flight can no longer be edited. You can only view current seat prices and statuses.
      </p>
    {% endif %}

    {# Detect which classes exist #}
    {% set ns = namespace(has_business=false, has_economy=false) %}
    {% for s in seats %}
      {% if s.Seat_Class == 'Business' %}{% set ns.has_business = true %}{% endif %}
      {% if s.Seat_Class == 'Economy' %}{% set ns.has_economy = true %}{% endif %}
    {% endfor %}

    {# ====== Filters bar ====== #}
    <div class="seat-toolbar">
      <div class="seat-toolbar-group">
        <label for="filter-seat-class">Filter by class</label>
        <select id="filter-seat-class"
                class="form-select dark-select small-select">
          <option value="ALL">All classes</option>
          {% if ns.has_business %}<option value="Business">Business</option>{% endif %}
          {% if ns.has_economy %}<option value="Economy">Economy</option>{% endif %}
        </select>
      </div>

      <div class="seat-toolbar-group">
        <label for="filter-seat-status">Filter by status</label>
        <select id="filter-seat-status"
                class="form-select dark-select small-select">
          <option value="ALL">All statuses</option>
          <option value="Available">Available</option>
          <option value="Blocked">Blocked</option>
          <option value="Sold">Sold</option>
        </select>
      </div>

      <div class="seat-toolbar-group">
        <label for="filter-seat-text">Filter by seat (Row X, Seat Y)</label>
        <input id="filter-seat-text"
               type="text"
               class="form-input small-input"
               placeholder="e.g. Row 1, Seat 1">
      </div>

      <div class="toolbar-actions">
        <button type="button" id="filter-clear" class="btn-secondary">
          Clear filters
        </button>
      </div>
    </div>

    <form method="post" class="seats-form">

      <div class="class-pricing-box">
        <h3 style="margin:0 0 0.25rem 0;">Class pricing</h3>
        <div class="hint">
          Step 1: set the new class price and click <b>Apply</b> to preview it on the table.<br>
          Step 2: click <b>Save seat pricing</b> to persist changes
        </div>

        {% if not is_readonly %}
          <div class="seat-toolbar" style="margin-bottom: 0;">
            {% if ns.has_business %}
              <div class="seat-toolbar-group">
                <label for="class_price_Business">Business price</label>
                <input
                  id="class_price_Business"
                  name="class_price_Business"
                  type="number"
                  min="0.01"
                  step="0.01"
                  class="form-input small-input"
                  value="{% if class_prices and class_prices.get('Business') is not none %}{{ "%.2f"|format(class_prices.get('Business')) }}{% endif %}"
                  placeholder="e.g. 499.00"
                >
              </div>
              <div class="toolbar-actions">
                <button type="button" id="apply-business-btn" class="btn-secondary">
                  Apply Business
                </button>
              </div>
            {% endif %}

            {% if ns.has_economy %}
              <div class="seat-toolbar-group">
                <label for="class_price_Economy">Economy price</label>
                <input
                  id="class_price_Economy"
                  name="class_price_Economy"
                  type="number"
                  min="0.01"
                  step="0.01"
                  class="form-input small-input"
                  value="{% if class_prices and class_prices.get('Economy') is not none %}{{ "%.2f"|format(class_prices.get('Economy')) }}{% endif %}"
                  placeholder="e.g. 199.99"
                >
              </div>
              <div class="toolbar-actions">
                <button type="button" id="apply-economy-btn" class="btn-secondary">
                  Apply Economy
                </button>
              </div>
            {% endif %}
          </div>
        {% else %}
          <div class="hint">
            {% if ns.has_business %}
              <div>Business: <b>{% if class_prices and class_prices.get('Business') is not none %}{{ "%.2f"|format(class_prices.get('Business')) }}{% else %}-{% endif %} $</b></div>
            {% endif %}
            {% if ns.has_economy %}
              <div>Economy: <b>{% if class_prices and class_prices.get('Economy') is not none %}{{ "%.2f"|format(class_prices.get('Economy')) }}{% else %}-{% endif %} $</b></div>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <div class="table-shell table-shell--seats">
        <table class="data-table seats-table">
          <thead>
            <tr>
              <th>Seat</th>
              <th>Class</th>
              <th>Price</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for s in seats %}
              <tr class="seat-row"
                  data-seat-class="{{ s.Seat_Class }}"
                  data-seat-status="{{ s.Seat_Status }}"
                  data-seat-label="Row {{ s.Row_Num }}, Seat {{ s.Col_Num }}"
                  data-row="{{ s.Row_Num }}"
                  data-col="{{ s.Col_Num }}">
                <td>Row {{ s.Row_Num }}, Seat {{ s.Col_Num }}</td>
                <td>
                  {% if s.Seat_Class == 'Business' %}
                    <span class="chip chip--business">{{ s.Seat_Class }}</span>
                  {% else %}
                    <span class="chip chip--economy">{{ s.Seat_Class }}</span>
                  {% endif %}
                </td>

                <td>
                  <span class="readonly-value js-seat-price">
                    {% if s.Seat_Price is not none %}
                      {{ "%.2f"|format(s.Seat_Price) }} $
                    {% else %}
                      -
                    {% endif %}
                  </span>
                </td>

                <td>
                  {% if is_readonly %}
                    <span class="readonly-value status-{{ s.Seat_Status|lower }}">
                      {{ s.Seat_Status }}
                    </span>
                  {% else %}
                    {% if s.Seat_Status == 'Sold' %}
                      <span class="readonly-value status-sold">Sold</span>
                    {% else %}
                      <select
                        name="status_{{ s.FlightSeat_id }}"
                        class="form-select dark-select small-select"
                      >
                        <option value="Available" {% if s.Seat_Status == 'Available' %}selected{% endif %}>Available</option>
                        <option value="Blocked" {% if s.Seat_Status == 'Blocked' %}selected{% endif %}>Blocked</option>
                      </select>
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="form-actions">
        {% if not is_readonly %}
          <button type="submit" class="btn-primary">
            Save seat pricing
          </button>

          <a href="{{ url_for('main.manager_flight_crew', flight_id=flight.Flight_id) }}"
             class="btn-secondary">
            Back to crew
          </a>
        {% else %}
          <a href="{{ url_for('main.manager_flights') }}"
             class="btn-secondary"
             data-allow-nav="true">
            Back to flights board
          </a>
        {% endif %}
      </div>
    </form>
  </section>

  <div class="seatmap-footer">
    <img src="{{ url_for('static', filename='img/seatmap.png') }}"
         alt="Example seat map layout">
    <div class="seatmap-footer-caption">
      Reference seat map for typical cabin layout.
    </div>
  </div>

</div>
{% endblock %}
